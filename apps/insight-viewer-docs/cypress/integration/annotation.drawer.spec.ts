import {
  setup,
  moveAnnotation,
  editAnnotation,
  drawAnnotation,
  drawAnnotations,
  deleteAndCheckAnnotationOrMeasurement,
} from '../support/utils'
import { VIEWPORT_WIDTH, VIEWPORT_HEIGHT, $LOADED } from '../support/const'
import {
  POLYGON_ANNOTATIONS,
  INTERSECTING_POLYGON_ANNOTATION,
  SMALLER_THAN_MINIMUM_AREA_POLYGON_ANNOTATION,
} from '../../mocks/polygons'
import { LINE_ANNOTATIONS, SMALLER_THAN_MINIMUM_LENGTH_LINE_ANNOTATION } from '../../mocks/lines'
import { FREELINE_ANNOTATIONS, SMALLER_THAN_MINIMUM_LENGTH_FREE_LINE_ANNOTATION } from '../../mocks/freeLines'

describe(
  'annotation drawer',
  {
    viewportWidth: VIEWPORT_WIDTH,
    viewportHeight: VIEWPORT_HEIGHT,
    scrollBehavior: false,
  },
  () => {
    const MOVING_DISTANCE = 100

    before(() => {
      setup()
      cy.visit('/annotation')
    })

    it('shows initial annotation', () => {
      cy.get($LOADED).should('be.exist')
      cy.get('[data-cy-tab="drawer"]').click()
    })

    describe('Polygon Annotation', () => {
      const mockPolygonAnnotationLength = POLYGON_ANNOTATIONS.length

      it('count polygon annotation before drawing', () => {
        cy.get('[data-cy-id]').should('have.length', 0)
      })

      it('cancel drawing when drawing intersecting polygons', () => {
        drawAnnotation(INTERSECTING_POLYGON_ANNOTATION)

        cy.get('[data-cy-id]').should('have.length', 0)
      })

      it('cancel drawing if smaller than the minimum area', () => {
        drawAnnotation(SMALLER_THAN_MINIMUM_AREA_POLYGON_ANNOTATION)

        cy.get('[data-cy-id]').should('have.length', 0)
      })

      it('Annotation polygon drawing', () => {
        drawAnnotations(POLYGON_ANNOTATIONS)

        cy.get('[data-cy-id]').should('have.length', mockPolygonAnnotationLength)
      })

      it('delete polygon annotation and count annotation', () => {
        const targetAnnotation = POLYGON_ANNOTATIONS[1]

        deleteAndCheckAnnotationOrMeasurement(targetAnnotation, 'not.exist')
        cy.get('[data-cy-id]').should('have.length', mockPolygonAnnotationLength - 1)
      })

      it('move polygon annotation', () => {
        const targetAnnotation = POLYGON_ANNOTATIONS[2]
        const targetDataAttr = `[data-cy-id="${targetAnnotation.id}"]`
        const beforeMovePolygonPoints =
          '195.99999999999997,238.26562499999997 190.99999999999997,238.26562499999997 189.99999999999997,238.26562499999997 185.99999999999997,240.26562499999997 182.99999999999997,241.26562499999997 180.99999999999994,242.26562499999994 178.99999999999997,244.26562499999997 174.99999999999997,246.26562499999994 170.99999999999997,249.26562499999994 166.99999999999997,253.26562499999997 163.99999999999997,256.26562499999994 160.99999999999997,259.26562499999994 157.99999999999997,262.26562499999994 154.99999999999997,265.26562499999994 153.99999999999997,266.26562499999994 149.99999999999997,270.26562499999994 148.99999999999997,272.26562499999994 148,274.26562499999994 146.99999999999997,276.26562499999994 146.99999999999997,277.265625 146.99999999999997,280.265625 148,283.26562499999994 148.99999999999997,285.26562499999994 149.99999999999997,287.26562499999994 151.99999999999997,289.26562499999994 153.99999999999997,291.26562499999994 155.99999999999997,293.265625 160.99999999999997,297.26562499999994 163.99999999999997,298.26562499999994 168.99999999999997,301.26562499999994 172.99999999999997,302.26562499999994 179.99999999999997,304.26562499999994 183.99999999999994,305.26562499999994 187.99999999999997,306.26562499999994 191.99999999999997,306.26562499999994 195.99999999999997,307.26562499999994 201.99999999999997,308.26562499999994 204.99999999999997,308.26562499999994 209.99999999999994,308.26562499999994 210.99999999999997,308.26562499999994 212.99999999999994,308.26562499999994 212.99999999999994,308.26562499999994 214.99999999999997,307.26562499999994 215.99999999999994,307.26562499999994 216.99999999999997,306.26562499999994 219.99999999999994,306.26562499999994 220.99999999999997,304.26562499999994 222.99999999999994,303.26562499999994 222.99999999999994,303.26562499999994 223.99999999999997,301.26562499999994 224.99999999999997,297.26562499999994 225.99999999999994,295.26562499999994 226.99999999999997,293.265625 227.99999999999997,290.26562499999994 228.99999999999994,285.26562499999994 229.99999999999997,281.26562499999994 230.99999999999997,279.26562499999994 231.99999999999997,277.265625 231.99999999999997,274.26562499999994 231.99999999999997,272.26562499999994 231.99999999999997,270.26562499999994 228.99999999999994,266.26562499999994 227.99999999999997,264.265625 225.99999999999994,261.265625 223.99999999999997,257.26562499999994 221.99999999999997,254.26562499999997 220.99999999999997,252.26562499999994 218.99999999999997,249.26562499999994 218.99999999999997,249.26562499999994 216.99999999999997,247.26562499999997 213.99999999999997,246.26562499999994 210.99999999999997,244.26562499999997 208.99999999999997,242.26562499999994 207.99999999999997,241.26562499999997 205.99999999999997,240.26562499999997 205.99999999999997,239.26562499999994 204.99999999999997,239.26562499999994 204.99999999999997,238.26562499999997 203,237.26562499999997 203,237.26562499999997 203,236.26562499999994 201.99999999999997,236.26562499999994 201.99999999999997,236.26562499999994 201.99999999999997,236.26562499999994'
        const movedPolygonPoints =
          '266,308.26562499999994 261,308.26562499999994 260,308.26562499999994 256,310.26562499999994 253,311.26562499999994 250.99999999999997,312.26562499999994 249,314.26562499999994 245.00000000000003,316.26562499999994 240.99999999999997,319.26562499999994 237,323.26562499999994 234,326.26562499999994 231,329.26562499999994 227.99999999999997,332.26562499999994 225.00000000000003,335.26562499999994 224,336.26562499999994 220,340.26562499999994 219.00000000000003,342.26562499999994 218,344.26562499999994 217,346.26562499999994 217,347.26562499999994 217,350.26562499999994 218,353.265625 219.00000000000003,355.26562499999994 220,357.26562499999994 221.99999999999997,359.265625 224,361.26562499999994 226,363.26562499999994 231,367.26562499999994 234,368.26562499999994 239,371.265625 243,372.265625 250,374.26562499999994 253.99999999999997,375.26562499999994 258,376.26562499999994 262,376.26562499999994 266,377.26562499999994 272,378.265625 275,378.265625 280,378.265625 281,378.265625 283,378.265625 283,378.265625 285,377.26562499999994 285.99999999999994,377.26562499999994 287,376.26562499999994 290,376.26562499999994 291,374.26562499999994 293,373.26562499999994 293,373.26562499999994 294,371.265625 295,367.26562499999994 296,365.265625 297,363.26562499999994 298,360.26562499999994 298.99999999999994,355.26562499999994 300,351.26562499999994 301,349.26562499999994 302,347.26562499999994 302,344.26562499999994 302,342.26562499999994 302,340.26562499999994 298.99999999999994,336.26562499999994 298,334.26562499999994 296,331.26562499999994 294,327.26562499999994 292,324.26562499999994 291,322.26562499999994 289,319.26562499999994 289,319.26562499999994 287,317.26562499999994 284,316.26562499999994 281,314.26562499999994 279,312.26562499999994 278,311.26562499999994 276,310.26562499999994 276,309.26562499999994 275,309.26562499999994 275,308.26562499999994 273,307.26562499999994 273,307.26562499999994 273,306.26562499999994 272,306.26562499999994 272,306.26562499999994 272,306.26562499999994'

        cy.get('[data-cy-edit="false"]').click()

        cy.get(`${targetDataAttr} > polygon`).invoke('attr', 'points').should('equal', beforeMovePolygonPoints)

        moveAnnotation(targetAnnotation, MOVING_DISTANCE)

        // count Line Annotation
        cy.get('[data-cy-id]').should('have.length', mockPolygonAnnotationLength - 1)

        // check moved Points of Line Annotation
        cy.get(`${targetDataAttr} > polygon`).invoke('attr', 'points').should('equal', movedPolygonPoints)
      })
    })

    describe('Line Annotation', () => {
      const mockLineAnnotationLength = LINE_ANNOTATIONS.length

      it('click reset', () => {
        cy.get('[data-cy-name="remove-button"]').click()
        cy.get('[data-cy-edit="true"]').click()
      })

      it('click line radio', () => {
        cy.get('[value="line"]').click({ force: true })
      })

      it('count line annotation before drawing', () => {
        cy.get('[data-cy-id]').should('have.length', 0)
      })

      it('cancel drawing if smaller than the minimum length', () => {
        drawAnnotation(SMALLER_THAN_MINIMUM_LENGTH_LINE_ANNOTATION)

        cy.get('[data-cy-id]').should('have.length', 0)
      })

      it('Annotation line drawing', () => {
        drawAnnotations(LINE_ANNOTATIONS)

        cy.get('[data-cy-id]').should('have.length', mockLineAnnotationLength)
      })

      it('delete line annotation and count annotation', () => {
        const targetAnnotation = LINE_ANNOTATIONS[1]

        deleteAndCheckAnnotationOrMeasurement(targetAnnotation, 'not.exist')
        cy.get('[data-cy-id]').should('have.length', mockLineAnnotationLength - 1)
      })

      it('move line annotation', () => {
        const targetAnnotation = LINE_ANNOTATIONS[2]
        const targetDataAttr = `[data-cy-id="${targetAnnotation.id}"]`
        const movedPolylinePoints = '250.99999999999994,363.26562499999994 359.99999999999994,393.26562499999994'

        cy.get('[data-cy-edit="false"]').click()

        moveAnnotation(targetAnnotation, MOVING_DISTANCE)

        // count Line Annotation
        cy.get('[data-cy-id]').should('have.length', mockLineAnnotationLength - 1)

        // check moved Points of Line Annotation
        cy.get(`${targetDataAttr} > polyline`).invoke('attr', 'points').should('equal', movedPolylinePoints)
      })

      it('edit start point position', () => {
        const targetAnnotation = LINE_ANNOTATIONS[3]
        const startPoint = targetAnnotation.points[0]
        const targetDataAttr = `[data-cy-id="${targetAnnotation.id}"]`
        const beforeEditpolylinePoints = '350.99999999999994,257.26562499999994 283.99999999999994,353.26562499999994'
        const editedPolylinePoints = '450.99999999999994,357.26562499999994 283.99999999999994,353.26562499999994'

        // check point coordinates before editing
        cy.get(`${targetDataAttr} > polyline`).invoke('attr', 'points').should('equal', beforeEditpolylinePoints)

        cy.get(targetDataAttr).click({ force: true })

        editAnnotation(startPoint, 100)

        // check point coordinates after editing
        cy.get(`${targetDataAttr} > polyline`).invoke('attr', 'points').should('equal', editedPolylinePoints)
      })

      it('edit end point position', () => {
        const targetAnnotation = LINE_ANNOTATIONS[3]
        const endPoint = targetAnnotation.points[1]
        const targetDataAttr = `[data-cy-id="${targetAnnotation.id}"]`
        const beforeEditpolylinePoints = '450.99999999999994,357.26562499999994 283.99999999999994,353.26562499999994'
        const editedPolylinePoints = '450.99999999999994,357.26562499999994 383.99999999999994,453.26562499999994'

        // check point coordinates before editing
        cy.get(`${targetDataAttr} > polyline`).invoke('attr', 'points').should('equal', beforeEditpolylinePoints)

        cy.get(targetDataAttr).click({ force: true })

        editAnnotation(endPoint, 100)

        // check point coordinates after editing
        cy.get(`${targetDataAttr} > polyline`).invoke('attr', 'points').should('equal', editedPolylinePoints)
      })
    })

    describe('Free Line Annotation', () => {
      const mockFreelineAnnotationLength = FREELINE_ANNOTATIONS.length

      it('click reset', () => {
        cy.get('[data-cy-name="remove-button"]').click()
        cy.get('[data-cy-edit="true"]').click()
      })

      it('click line radio', () => {
        cy.get('[value="freeLine"]').click({ force: true })
      })

      it('count freeline annotation before drawing', () => {
        cy.get('[data-cy-id]').should('have.length', 0)
      })

      it('cancel drawing if smaller than the minimum area', () => {
        drawAnnotation(SMALLER_THAN_MINIMUM_LENGTH_FREE_LINE_ANNOTATION)

        cy.get('[data-cy-id]').should('have.length', 0)
      })

      it('Annotation freeline drawing', () => {
        drawAnnotations(FREELINE_ANNOTATIONS)

        cy.get('[data-cy-id]').should('have.length', mockFreelineAnnotationLength)
      })

      it('delete freeline annotation and count annotation', () => {
        const targetAnnotation = FREELINE_ANNOTATIONS[1]

        deleteAndCheckAnnotationOrMeasurement(targetAnnotation, 'not.exist')
        cy.get('[data-cy-id]').should('have.length', mockFreelineAnnotationLength - 1)
      })

      it('move freeline annotation', () => {
        const targetAnnotation = FREELINE_ANNOTATIONS[2]
        const targetDataAttr = `[data-cy-id="${targetAnnotation.id}"]`
        const beforeMovePolygonPoints =
          '321.99999999999994,276.26562499999994 321.99999999999994,276.26562499999994 320.99999999999994,276.26562499999994 318.99999999999994,276.26562499999994 315.99999999999994,276.26562499999994 313.99999999999994,277.265625 307.99999999999994,279.26562499999994 304.99999999999994,280.265625 300.99999999999994,282.26562499999994 296.99999999999994,284.26562499999994 292.99999999999994,286.26562499999994 291.99999999999994,287.26562499999994 285.99999999999994,289.26562499999994 283,291.26562499999994 280.99999999999994,291.26562499999994 279.99999999999994,293.265625 277.99999999999994,294.26562499999994 277.99999999999994,295.26562499999994 277.99999999999994,295.26562499999994 277.99999999999994,295.26562499999994 277.99999999999994,295.26562499999994 277.99999999999994,295.26562499999994 277.99999999999994,295.26562499999994 277.99999999999994,296.26562499999994 277.99999999999994,296.26562499999994 277.99999999999994,296.26562499999994 277.99999999999994,297.26562499999994 277.99999999999994,297.26562499999994 278.99999999999994,297.26562499999994 278.99999999999994,298.26562499999994 278.99999999999994,298.26562499999994 280.99999999999994,299.26562499999994 283.99999999999994,302.26562499999994 284.99999999999994,303.26562499999994 287.99999999999994,304.26562499999994 288.99999999999994,304.26562499999994 291.99999999999994,304.26562499999994 294.99999999999994,305.26562499999994 297.99999999999994,305.26562499999994 300.99999999999994,305.26562499999994 307.99999999999994,305.26562499999994 310.99999999999994,305.26562499999994 317.99999999999994,306.26562499999994 322.99999999999994,306.26562499999994 325.99999999999994,306.26562499999994 328.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,306.26562499999994 329.99999999999994,307.26562499999994 329.99999999999994,307.26562499999994 329.99999999999994,307.26562499999994 328.99999999999994,307.26562499999994 328.99999999999994,308.26562499999994 328.99999999999994,308.26562499999994 327.99999999999994,308.26562499999994 326.99999999999994,309.265625 326.99999999999994,309.265625 323.99999999999994,311.26562499999994 321.99999999999994,312.26562499999994 318.99999999999994,313.26562499999994 314.99999999999994,316.26562499999994 312.99999999999994,317.26562499999994 312.99999999999994,317.26562499999994 311.99999999999994,319.26562499999994 310.99999999999994,319.26562499999994 309.99999999999994,320.26562499999994 309.99999999999994,320.26562499999994 308.99999999999994,320.26562499999994 307.99999999999994,321.26562499999994 305.99999999999994,322.26562499999994 304.99999999999994,322.26562499999994 302.99999999999994,322.26562499999994 302.99999999999994,322.26562499999994 302.99999999999994,322.26562499999994 301.99999999999994,322.26562499999994 301.99999999999994,322.26562499999994 300.99999999999994,322.26562499999994 300.99999999999994,322.26562499999994 300.99999999999994,322.26562499999994 299.99999999999994,322.26562499999994 299.99999999999994,322.26562499999994 299.99999999999994,322.26562499999994 298.99999999999994,322.26562499999994 297.99999999999994,322.26562499999994 296.99999999999994,322.26562499999994 296.99999999999994,321.26562499999994 296.99999999999994,321.26562499999994 296,321.26562499999994 294.99999999999994,321.26562499999994 294.99999999999994,321.26562499999994 294.99999999999994,321.26562499999994 294.99999999999994,321.26562499999994 294.99999999999994,321.26562499999994 294.99999999999994,321.26562499999994 293.99999999999994,321.26562499999994'
        const movedPolygonPoints =
          '391.99999999999994,346.26562499999994 391.99999999999994,346.26562499999994 390.99999999999994,346.26562499999994 388.99999999999994,346.26562499999994 385.9999999999999,346.26562499999994 383.99999999999994,347.26562499999994 377.99999999999994,349.26562499999994 374.9999999999999,350.26562499999994 370.99999999999994,352.265625 366.99999999999994,354.26562499999994 362.99999999999994,356.26562499999994 362,357.26562499999994 355.99999999999994,359.265625 352.99999999999994,361.26562499999994 350.99999999999994,361.26562499999994 349.99999999999994,363.26562499999994 347.99999999999994,364.26562499999994 347.99999999999994,365.265625 347.99999999999994,365.265625 347.99999999999994,365.265625 347.99999999999994,365.265625 347.99999999999994,365.265625 347.99999999999994,365.265625 347.99999999999994,366.265625 347.99999999999994,366.265625 347.99999999999994,366.265625 347.99999999999994,367.26562499999994 347.99999999999994,367.26562499999994 348.99999999999994,367.26562499999994 348.99999999999994,368.26562499999994 348.99999999999994,368.26562499999994 350.99999999999994,369.26562499999994 353.9999999999999,372.265625 355,373.26562499999994 357.99999999999994,374.26562499999994 358.99999999999994,374.26562499999994 362,374.26562499999994 364.99999999999994,375.26562499999994 367.9999999999999,375.26562499999994 370.99999999999994,375.26562499999994 377.99999999999994,375.26562499999994 380.9999999999999,375.26562499999994 387.9999999999999,376.26562499999994 392.9999999999999,376.26562499999994 395.99999999999994,376.26562499999994 398.99999999999994,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,376.26562499999994 399.9999999999999,377.26562499999994 399.9999999999999,377.26562499999994 399.9999999999999,377.26562499999994 398.99999999999994,377.26562499999994 398.99999999999994,378.265625 398.99999999999994,378.265625 397.99999999999994,378.265625 396.99999999999994,379.265625 396.99999999999994,379.265625 394,381.26562499999994 391.99999999999994,382.26562499999994 388.99999999999994,383.26562499999994 384.99999999999994,386.26562499999994 382.99999999999994,387.26562499999994 382.99999999999994,387.26562499999994 381.99999999999994,389.26562499999994 380.9999999999999,389.26562499999994 379.99999999999994,390.265625 379.99999999999994,390.265625 378.9999999999999,390.265625 377.99999999999994,391.265625 375.99999999999994,392.26562499999994 374.9999999999999,392.26562499999994 372.9999999999999,392.26562499999994 372.9999999999999,392.26562499999994 372.9999999999999,392.26562499999994 371.99999999999994,392.26562499999994 371.99999999999994,392.26562499999994 370.99999999999994,392.26562499999994 370.99999999999994,392.26562499999994 370.99999999999994,392.26562499999994 369.99999999999994,392.26562499999994 369.99999999999994,392.26562499999994 369.99999999999994,392.26562499999994 369,392.26562499999994 367.9999999999999,392.26562499999994 366.99999999999994,392.26562499999994 366.99999999999994,391.265625 366.99999999999994,391.265625 365.99999999999994,391.265625 364.99999999999994,391.265625 364.99999999999994,391.265625 364.99999999999994,391.265625 364.99999999999994,391.265625 364.99999999999994,391.265625 364.99999999999994,391.265625 363.99999999999994,391.265625'
        cy.get('[data-cy-edit="false"]').click()

        cy.get(`${targetDataAttr} > polyline`).invoke('attr', 'points').should('equal', beforeMovePolygonPoints)

        moveAnnotation(targetAnnotation, MOVING_DISTANCE)

        // count Line Annotation
        cy.get('[data-cy-id]').should('have.length', mockFreelineAnnotationLength - 1)

        // check moved Points of Line Annotation
        cy.get(`${targetDataAttr} > polyline`).invoke('attr', 'points').should('equal', movedPolygonPoints)
      })
    })
  }
)
